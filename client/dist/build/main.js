!function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){n(1)(angular),n(8)(angular),n(10)(angular);var r=angular.module("app",["ui.router","restangular","ui.bootstrap","siteModules","siteServices","siteFilters","angular-toasty","angularFileUpload"]);r.run(["$rootScope","$state","$stateParams",function(t,e,n){t.$state=e,t.$stateParams=n}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t,e){e.otherwise("/site")}]),r.config(["toastyConfigProvider",function(t){t.setConfig({})}]),r.config(["RestangularProvider",function(t){t.setBaseUrl("/api")}]),r.constant("constant",{ARTICLES:{}}),n(14)(r),angular.bootstrap(document,["app"])},function(t,e,n){t.exports=function(t){var e=t.module("siteModules",["ngSanitize"]);n(2)(e),n(3)(e),n(4)(e),n(5)(e),n(6)(e),n(7)(e)}},function(t){t.exports=function(t){t.directive("siteHeader",[function(){var t={restrict:"E",replace:"true",templateUrl:"/site/modules/header/index.html",link:function(t){t.adminMenus=[{title:"文档管理",subMenus:[{title:"文档列表",sref:"articles"},{title:"新增文档",sref:"addArticle"}]},{title:"分类管理",subMenus:[{title:"新增分类",sref:"addTag"}]},{title:"成员管理",subMenus:[{title:"新增成员",sref:"addUser"},{title:"成员列表",sref:"users"}]}],t.userMenus=[{title:"文档管理",subMenus:[{title:"新增文档",sref:"addArticle"}]}]},scope:!1,controller:["$scope","$rootScope","$stateParams","$state","$http",function(t,e,n,r,o){t.$on("userChange",function(e,n){n&&(t.user=n.user)}),t.isLogin=function(){o({method:"post",url:"/api/sign/isLogin"}).success(function(n){if(200===n.code){var r=n.msg.user;e.user=r,t.user=r}})},t.isLogin(),t.searchBox={keyword:""},t.searchKeyword=function(){r.go("articles",{tag:n.tag,page:n.page,keyword:t.searchBox.keyword})},t.signout=function(t){return window.location.replace("/api/sign/out"),t.preventDefault(),t.stopPropagation(),!1}}]};return t}])}},function(t){t.exports=function(t){t.directive("fedocPagination",["$location",function(t){var e={restrict:"E",templateUrl:"/site/modules/pagination/index.html",replace:!0,transclude:!0,require:"ngModel",scope:{ngModel:"=",turn:"&"},link:function(e,n,r){e.$watch("ngModel",function(t){t&&(e.pagination=t)}),e.search=r.turn?function(t){e.turn({data:t})}:function(e){var n=t.search();n.page=e,t.path(t.path()).search(n)}}};return e}])}},function(t){t.exports=function(t){var e=window.markdownit();t.directive("fedocMarkdown",["$sanitize",function(t){return{restrict:"AE",link:function(n,r,o){if(o.fedocMarkdown)n.$watch(o.fedocMarkdown,function(n){var o=n?t(e.render(n)):"";r.html(o)});else{var i=t(e.render(r.text()));r.html(i)}}}}])}},function(t){t.exports=function(t){t.directive("fedocEnter",function(){return{restrict:"AC",link:function(t,e,n){e.bind("keydown",function(e){return 13===event.which?(t.$apply(function(){t.$eval(n.fedocEnter)}),e.stopPropagation(),!1):void 0})}}})}},function(t){t.exports=function(t){t.directive("articleTags",[function(){var t={restrict:"E",replace:"true",templateUrl:"/site/modules/article-tags/index.html",scope:!1,controller:["$scope","toasty","$rootScope","TagService","$stateParams","$state",function(t,e,n,r,o,i){r.listAll().then(function(e){200===e.code&&(t.tags=e.msg.tags)}),t.tag=o.tag||"",t.choose=function(e,n){t.tag=n,i.go("articles",{tag:n}),e.stopPropagation()},t.delTag=function(n,o){confirm("确认删除该分类吗")&&r.remove(o._id).then(function(n){if(200===n.code){e.success("删除分类成功");for(var r=0,a=t.tags.length;a>r;r++)if(t.tags[r]._id===o._id)return t.tags.splice(r,1),void(t.tag===o.name&&i.go("articles",{tag:""}))}}),n.stopPropagation()}}]};return t}])}},function(t){t.exports=function(t){t.directive("btnToTop",["$window",function(t){var e={restrict:"E",replace:"true",template:' <div class="btn-to-top"></div>',scope:!1,link:function(e,n){angular.element(t).bind("scroll",function(){var t=window.document.body.scrollTop;t>40?n.addClass("active"):n.removeClass("active")}),n.on("click",function(){window.document.body.scrollTop=0})}};return e}])}},function(t,e,n){t.exports=function(t){var e=t.module("siteFilters",[]);n(9)(e)}},function(t){t.exports=function(t){t.filter("dayDisplay",["$filter",function(t){var e=t("date");return function(t){return null==t||""==t?"":e(t,"yyyy-MM-dd")}}]),t.filter("dateAgo",["$filter",function(t){t("date");return function(t){if(null==t||""==t)return"";var e=(new Date).getTime(),n=new Date(t).getTime(),r=parseInt((e-n)/1e3);return 60>r?parseInt(r)+"秒前":3600>r?parseInt(r/60)+"分钟前":86400>r?parseInt(r/3600)+"小时前":2592e3>r?parseInt(r/86400)+"天前":94608e4>r?parseInt(r/2592e3)+"月前":parseInt(r/31104e3)+"年前"}}])}},function(t,e,n){t.exports=function(t){var e=t.module("siteServices",["restangular"]);n(11)(e),n(12)(e),n(13)(e)}},function(t){t.exports=function(t){t.factory("ArticleService",["Restangular","$timeout",function(t){var e=t.all("articles");return{list:function(t){return e.customGET("",t)},getOne:function(t){return e.one(t).customGET()},remove:function(t){return e.one(t).remove()},create:function(t){return e.customPOST(t)},update:function(t,n){return e.one(t).customPUT(n)}}}])}},function(t){t.exports=function(t){t.factory("UserService",["Restangular","$timeout",function(t){var e=t.all("users");return{list:function(t){return e.customGET("",t)},listAll:function(t){return e.customGET("all",t)},getOne:function(t){return e.one(t).customGET()},remove:function(t){return e.one(t).remove()},create:function(t){return e.customPOST(t)},updateInfo:function(t,n){return e.one(t,"info").customPUT(n)},updatePwd:function(t,n){return e.one(t,"pwd").customPUT(n)}}}])}},function(t){t.exports=function(t){t.factory("TagService",["Restangular","$timeout",function(t){var e=t.all("tags");return{listAll:function(t){return e.customGET("",t)},getOne:function(t){return e.one(t).customGET()},remove:function(t){return e.one(t).remove()},create:function(t){return e.customPOST(t)},update:function(t,n){return e.one(t).customPUT(n)}}}])}},function(t,e,n){t.exports=function(t){t.controller("SiteController",["$scope","$rootScope","$http","$state","$window",function(t,e,n,r){t.user={email:"zhangc@fxiaoke.com",pwd:"123456"},r.go("articles")}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("site",{url:"/site",templateUrl:"/site/index.html",pageTitle:"主页",controller:"SiteController"})}]),n(15)(t),n(16)(t),n(17)(t),n(18)(t),n(19)(t),n(20)(t),n(23)(t)}},function(t){t.exports=function(t){t.controller("ArticleListController",["$scope","$state","$stateParams","ArticleService","constant",function(t,e,n,r){t.query={keyword:n.keyword,page:n.page,tag:n.tag},t.list=function(e){var n=_.extend(t.query,e);r.list(n).then(function(e){t.articles=e.msg.articles,t.pagination=e.msg.pagination,t.count=e.msg.count})},t.init=function(){t.list()}}]),t.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("articles",{url:"/articles?page&tag&keyword",templateUrl:"/site/tpls/articles/index.html",pageTitle:"文档列表",controller:"ArticleListController"})}])}},function(t){t.exports=function(t){t.controller("ArticleController",["$scope","$state","$stateParams","ArticleService","UserService","toasty","isAdd","constant","TagService","$upload","$rootScope",function(t,e,n,r,o,i,a,c,s,l,u){function f(e){t.uploading=!0,l.upload({url:"/api/attachments/upload",file:e}).progress(function(){}).success(function(e){200===e.code&&(t.article.attachments=t.article.attachments||[],t.article.attachments.push({fileUrl:e.msg.fileUrl,fileName:e.msg.fileName})),t.uploading=!1}).error(function(){t.uploading=!1})}var d,p=n._id;t.article={tags:[],isPreview:!1},t.create=function(){t.article.content=d.value(),r.create(t.article).then(function(t){200===t.code?(i.success("创建文档成功"),e.go("articles")):i.error(t.msg)})},t.init=function(){s.listAll().then(function(e){if(200===e.code){var n=e.msg.tags;t.tags=[];for(var r=0,o=n.length;o>r;r++)t.tags.push(n[r].name)}}),a?t.article.isAdd=!0:r.getOne(p).then(function(e){200===e.code?(t.article=e.msg,u.user&&u.user.isAdmin&&t.initAllUsers()):i.error(e.msg)})},t.initAllUsers=function(){o.listAll().then(function(e){200===e.code&&(t.users=e.msg.users)})},t.initEditor=function(){d=new SimpleMDE({element:document.getElementById("editor")}),d.value(t.article.content)},t.del=function(){confirm("确认删除文档吗")&&r.remove(t.article._id).then(function(t){200===t.code&&(i.success("删除文档成功"),e.go("articles",{tag:""}))})},t.uploadAttachment=function(t){for(var e=0,n=t.length;n>e;e++)f(t[e])},t.delAttachment=function(e){t.article.attachments.splice(e,1)},t.init(),t.update=function(){r.update(p,{title:t.article.title,content:d.value(),tags:t.article.tags,user:t.article.user._id,attachments:t.article.attachments}).then(function(t){200===t.code?(i.success("更新文档成功"),window.location.reload()):i.error(t.msg)})},t.isCheckTag=function(e){return t.article.tags.indexOf(e)>-1},t.chooseTag=function(e,n){var r=e.currentTarget,o=t.article.tags.indexOf(n);r.checked?-1===o&&t.article.tags.push(n):-1!==o&&t.article.tags.splice(o,1)}}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("addArticle",{url:"/article/add",templateUrl:"/site/tpls/article/index.html",controller:"ArticleController",pageTitle:"新增文章",resolve:{isAdd:[function(){return!0}]}}).state("viewArticle",{url:"/articles/:_id",templateUrl:"/site/tpls/article/index.html",controller:"ArticleController",pageTitle:"查看文章",resolve:{isAdd:[function(){return!1}]}})}])}},function(t){t.exports=function(t){t.controller("UserListController",["$scope","$state","$stateParams","UserService","constant","toasty",function(t,e,n,r,o,i){t.query={page:n.page},t.list=function(e){var n=_.extend(t.query,e);r.list(n).then(function(e){t.users=e.msg.users,t.pagination=e.msg.pagination,t.count=e.msg.count})},t.del=function(e){confirm("确认删除用户吗")&&r.remove(e._id).then(function(n){if(200===n.code){i.success("删除用户");for(var r=0,o=t.users.length;o>r;r++)if(t.users[r]._id===e._id)return void t.users.splice(r,1)}})},t.init=function(){t.list()}}]),t.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("users",{url:"/users?page",templateUrl:"/site/tpls/users/index.html",pageTitle:"文档列表",controller:"UserListController"})}])}},function(t){t.exports=function(t){t.controller("UserController",["$scope","$state","$stateParams","UserService","toasty","isAdd",function(t,e,n,r,o){t.form={email:""},t.create=function(){var n=t.form;r.create({email:n.email}).then(function(t){200===t.code?(o.success("创建成员成功"),e.go("users")):o.error(t.msg)})}}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("addUser",{url:"/user/add",templateUrl:"/site/tpls/user/index.html",controller:"UserController",pageTitle:"新增成员",resolve:{isAdd:[function(){return!0}]}})}])}},function(t){t.exports=function(t){t.controller("TagController",["$scope","$state","$stateParams","TagService","toasty","isAdd","constant",function(t,e,n,r,o,i){var a=n._id;t.tag={name:""},t.create=function(){r.create(t.tag).then(function(t){200===t.code?(o.success("创建分类成功"),e.go("articles")):o.error(t.msg)})},t.init=function(){i?t.tag.isAdd=!0:r.getOne(a).then(function(e){200===e.code?t.tag=e.msg:o.error(e.msg)})},t.init(),t.update=function(){r.update(a,{name:t.tag.name,sort:t.tag.sort}).then(function(t){200===t.code?(o.success("更新分类成功"),e.go("articles")):o.error(t.msg)})}}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("addTag",{url:"/tag/add",templateUrl:"/site/tpls/tag/index.html",controller:"TagController",pageTitle:"新增分类",resolve:{isAdd:[function(){return!0}]}}).state("viewTag",{url:"/tags/:_id",templateUrl:"/site/tpls/tag/index.html",controller:"TagController",pageTitle:"查看分类",resolve:{isAdd:[function(){return!1}]}})}])}},function(t,e,n){t.exports=function(t){n(21)(t),n(22)(t),t.controller("ProfileController",["$scope","$rootScope","$http","$state","toasty",function(t,e,n,r){r.is("profile")&&r.go("profile.info")}]),t.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("profile",{url:"/profile",templateUrl:"/site/tpls/profile/index.html",controller:"ProfileController",pageTitle:"基本信息"}).state("profile.info",{url:"/info",templateUrl:"/site/tpls/profile/info/index.html",controller:"ProfileInfoController",pageTitle:"基本信息"}).state("profile.pwd",{url:"/pwd",templateUrl:"/site/tpls/profile/pwd/index.html",controller:"ProfilePwdController",pageTitle:"密码修改"})}])}},function(t){t.exports=function(t){t.controller("ProfilePwdController",["$scope","$rootScope","$http","$state","toasty","UserService",function(t,e,n,r,o,i){t.updatePwd=function(){i.updatePwd(e.user._id,{pwd:t.form.pwd,npwd:t.form.npwd,cpwd:t.form.cpwd}).then(function(t){200===t.code?(o.success("修改密码成功"),window.location.reload()):o.error(t.msg)})}}])}},function(t){t.exports=function(t){t.controller("ProfileInfoController",["$scope","$rootScope","$http","$state","toasty","UserService","$upload",function(t,e,n,r,o,i,a){var c=e.user;t.form={avatar:c.avatar,email:c.email,nickname:c.nickname},t.updateInfo=function(){i.updateInfo(c._id,{nickname:t.form.nickname,avatar:t.form.avatar}).then(function(t){200===t.code?(o.success("修改信息成功"),window.location.reload()):o.error(t.msg)})},t.uploadAvatar=function(e){var n=e[0];t.uploading=!0,a.upload({url:"/api/attachments/upload",file:n}).progress(function(){}).success(function(e){200===e.code&&(t.form.avatar=e.msg.fileUrl),t.uploading=!1}).error(function(){})}}])}},function(t){t.exports=function(t){t.controller("SigninController",["$scope","$rootScope","$http","$state","toasty",function(t,e,n,r,o){t.login=function(){n({method:"post",url:"/api/sign/login",data:{email:t.form.email||"",pwd:t.form.pwd||""}}).success(function(t){if(200===t.code){var n=t.msg.user;e.user=n,o.success("登陆成功"),e.$broadcast("userChange",{user:n}),r.go("articles")}else o.error(t.msg)})}}]),t.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t){t.state("signin",{url:"/signin",templateUrl:"/site/tpls/signin/index.html",controller:"SigninController",pageTitle:"登录"})}])}}]);